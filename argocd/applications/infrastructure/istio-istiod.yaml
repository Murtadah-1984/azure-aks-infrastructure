apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: istio-istiod
  namespace: argocd
  labels:
    app.kubernetes.io/name: istio-istiod
    app.kubernetes.io/component: control-plane
    app.kubernetes.io/part-of: istio
    environment: production
  annotations:
    argocd.argoproj.io/sync-wave: "1"
    description: "Istio control plane (istiod)"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: infrastructure
  source:
    chart: istiod
    repoURL: https://istio-release.storage.googleapis.com/charts
    targetRevision: 1.20.1
    helm:
      releaseName: istiod
      values: |
        global:
          proxy:
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 2000m
                memory: 1024Mi
        
        pilot:
          autoscaleEnabled: true
          autoscaleMin: 2
          autoscaleMax: 5
          replicaCount: 2
          
          resources:
            requests:
              cpu: 500m
              memory: 2048Mi
            limits:
              cpu: 1000m
              memory: 4096Mi
          
          # Enable Prometheus metrics
          env:
            PILOT_ENABLE_PROTOCOL_SNIFFING_FOR_OUTBOUND: "true"
            PILOT_ENABLE_PROTOCOL_SNIFFING_FOR_INBOUND: "true"
        
        meshConfig:
          accessLogFile: /dev/stdout
          accessLogEncoding: JSON
          
          defaultConfig:
            tracing:
              zipkin:
                address: jaeger-collector.observability:9411
          
          enablePrometheusMerge: true
          
          # Integrate with existing Prometheus
          extensionProviders:
            - name: prometheus
              prometheus: {}
  
  destination:
    server: https://kubernetes.default.svc
    namespace: istio-system
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
    retry:
      limit: 3
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m